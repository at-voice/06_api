<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ğŸ’„LIP MONSTER HUNTERğŸ’‹</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Shippori+Antique+B1&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rubik+Marker+Hatch&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="css/style.css">
</head>

<body>

    <header>
        <h1>LIP MONSTER</h1>
        <h1>HUNTERğŸ’‹</h1>
    </header>


    <main>

        <!-- ãƒãƒƒãƒ—è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="map" style="position:relative;width:360px;height:450px;"></div>
        <div id="output_p"></div>

        <!-- ç¾åœ¨åœ° -->
        <div class="current_location_wrapper">
            <p>ç·¯åº¦ ã€<a id="lat"></a>ã€‘</p>
            <p>çµŒåº¦ ã€<a id="lng"></a>ã€‘</p>
        </div>


        <!-- ä½ç½®ç‰¹å®šãƒ•ã‚©ãƒ¼ãƒ  -->
        <form>
            <fieldset>
                <div class="lat_land_input">
                    <div>
                        <div>
                            ç·¯åº¦ <input type="text" id="input_lat">
                        </div>
                        <div>
                            çµŒåº¦ <input type="text" id="input_lng">
                        </div>
                    </div>

                    <div>
                        <button type="button" id="send2">ç§»å‹•</button>
                    </div>
                </div>
            </fieldset>
        </form>

        <div class="blank"></div>


        <!-- æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ  â€»æœª-->
        <form>
            <div class="post_wrapper">

                <div class="post_form">
                    <div>
                        åº—èˆ—å <input type="text" id="storeName" placeholder="ãƒãƒ„ã‚­ãƒ¨ å¤©åœ°ä¸‹">
                    </div>
                    <div>
                        å•†å“å <input type="text" id="itemName" placeholder="13">
                    </div>

                    <div>
                        ç·¯åº¦ <input type="text" id="submit_lat">
                    </div>

                    <div>
                        çµŒåº¦ <input type="text" id="submit_lng">
                    </div>
                </div>

                <div>
                    <button type="button" id="send">ç™»éŒ²</button>
                </div>
            </div>
        </form>


        <div class="blank"></div>


        <!-- æŠ•ç¨¿ä¸€è¦§ -->
        <div id="output"></div>







    </main>

    <!-- JSã“ã“ã‹ã‚‰ -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>



    <!-- â˜…â˜…â˜…BING MAP -->
    <script src="js/BmapQuery.js"></script>
    <!-- API KEY -->
    <script
        src="https://www.bing.com/api/maps/mapcontrol?callback=GetMap&key=Arz2aNOTTDeKa4qpl1M99ds4QxY1mtwlQrmlUD0_RtiCiXQbdz9KZXlNv2P-_l4L"
        async defer>
        </script>

    <script>

        // window.onload = function () {...} ã‚’ç”¨ã„ã‚‹ã“ã¨ã§ï¼Œå…¨ã¦ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã‹ã‚‰ {} å†…ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«è¨˜è¿°ã§ãã‚‹

        window.onload = function () {
            navigator.geolocation.getCurrentPosition(mapsInit, showError, option);
        };

        // ãƒ”ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°

        function pushPin(lat, lng, map) {
            const location = new Microsoft.Maps.Location(lat, lng);
            const pin = new Microsoft.Maps.Pushpin(location, {
                color: "navy",
                visible: true,
            });
            map.entities.push(pin);
        }

        // ãƒ”ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°2(å…¥åŠ›ã—ãŸå€¤ã‹ã‚‰)

        function pushPin(lat, lng, map) {
            const location = new Microsoft.Maps.Location(lat, lng);
            const pin = new Microsoft.Maps.Pushpin(location, {
                color: "red",
                visible: true,
            });
            map.entities.push(pin);
        }







        // ä½ç½®æƒ…å ±ã‚’å–ã‚‹ãŸã‚ã«ä½¿ã†é–¢æ•°ã‚’ä½œã‚‹ï¼ˆæº–å‚™ï¼‰

        let map;

        // geo_and_map.html

        function mapsInit(position) {
            console.log(position.coords.latitude);
            console.log(position.coords.longitude);
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;

            // ãƒãƒƒãƒ—ã‚’å¼•ã£å¼µã£ã¦ãã‚‹ã€ãã®ä¸­å¤®ã¯latã¨lng
            map = new Microsoft.Maps.Map("#map", {
                center: {
                    latitude: lat,
                    longitude: lng,
                },
                zoom: 15,
            });
        }

        // ãƒ”ãƒ³ã‚’ç«‹ã¦ã‚‹é–¢æ•°

        function mapsInit(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            map = new Microsoft.Maps.Map("#map", {
                center: {
                    latitude: lat,
                    longitude: lng,
                },
                zoom: 15,
            });
            pushPin(lat, lng, map);
        }

        // infoboxï¼ˆå¹ãå‡ºã—ï¼‰ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
        // geo_and_map.html

        // function generateInfobox(lat, lng, map) {
        //     const location = new Microsoft.Maps.Location(lat, lng);
        //     const infobox = new Microsoft.Maps.Infobox(location, {
        //         title: `G's ACADEMY`,
        //         description: "JavaScript!!!",
        //     });
        //     infobox.setMap(map);
        // }


        // ãƒãƒƒãƒ—è¡¨ç¤ºå¾Œã«é–¢æ•°ã‚’å®Ÿè¡Œã™ã‚‹ï¼
        function mapsInit(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            map = new Microsoft.Maps.Map("#map", {
                center: {
                    latitude: lat,
                    longitude: lng,
                },
                zoom: 15,
            });
            pushPin(lat, lng, map);
            generateInfobox(lat, lng, map);
        }




        // 
        function showPosition(position) { //ä½ç½®æƒ…å ±ã®å–å¾—ã«æˆåŠŸã—ãŸå ´åˆã«å®Ÿè¡Œã•ã‚Œã‚‹é–¢æ•°"showPosition"ã‚’ã¤ãã‚‹
            console.log(position);
            const lat = position.coords.latitude;//ç·¯åº¦
            const lng = position.coords.longitude;//çµŒåº¦  
            console.log(lat, lng);

            $("#lat").text(lat)
            $("#lng").text(lng)


        }

        //ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ãŸå ´åˆã«å®Ÿè¡Œã•ã‚Œã‚‹é–¢æ•°
        // ã‚¨ãƒ©ãƒ¼ã®ç¨®é¡ã®é †ç•ªã¯æ±ºã¾ã£ã¦ã„ã‚‹
        function showError(error) {
            const errorMessages = [
                "ä½ç½®æƒ…å ±ãŒè¨±å¯ã•ã‚Œã¦ã¾ã›ã‚“",
                "ç¾åœ¨ä½ç½®ã‚’ç‰¹å®šã§ãã¾ã›ã‚“",
                "ä½ç½®æƒ…å ±ã‚’å–å¾—ã™ã‚‹å‰ã«ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã«ãªã‚Šã¾ã—ãŸ",
            ];
            alert(`error:${errorMessages[error.code - 1]}`);
        }

        // ä½ç½®æƒ…å ±ã®å–å¾—ã«å¿…è¦ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³
        const option = {
            enableHighAccuracy: true,
            maximumAge: 20000,
            timeout: 1000000,
        };




        // ä½ç½®æƒ…å ±ã‚’ã¨ã‚‹
        navigator.geolocation.getCurrentPosition(showPosition, showError, option);;





    </script>


    <!-- â˜…â˜…â˜…Firestore Database -->
    <!-- API KEY -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.14.0/firebase-app.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        import {
            getFirestore,
            collection,
            addDoc,
            serverTimestamp,
            query,
            orderBy,
            onSnapshot, //firebaseãŒæŒã£ã¦ã‚‹é–¢æ•°ã‚’å¼•ã£å¼µã£ã¦ãã‚‹
        } from "https://www.gstatic.com/firebasejs/9.14.0/firebase-firestore.js";


        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAY9-_p-2tYGNZ7ovnE8xGiC4mBr8KvzhM",
            authDomain: "homework-api-368607.firebaseapp.com",
            projectId: "homework-api-368607",
            storageBucket: "homework-api-368607.appspot.com",
            messagingSenderId: "126166796208",
            appId: "1:126166796208:web:c1b53aaf8c7330efd57875"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // å‹•ä½œã«é–¢ã‚ã‚‹è¨˜è¿°â†“

        // chatapp.html

        $("#send").on("click", function () {
            // é€ä¿¡æ™‚ã«å¿…è¦ãªå‡¦ç†

            const storeName = $("#storeName").val();
            const itemName = $("#itemName").val();

            const postData = {
                // name: firstname, //valâ†’è¦ç´ ãªã©ã®valueå€¤ã‚’å–å¾—ã™ã‚‹.nameã‚„textã¯key.

                // number: comment,
                // place: comment,
                storeName: storeName,
                itemName: itemName,
                time: serverTimestamp(), //â˜…serverTimestampâ†’FBã®ä»•æ§˜ã§ç¾åœ¨æ™‚åˆ»ã‚’ã¨ã£ã¦ãã‚‹
            }; //postDataã®å®šæ•°ã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå‹ã®å®šæ•°ã€‚ä»¥é™å‡ºã¦ãã¦ã‚‚postDataã®ä¸­èº«ã¯ã„ã˜ã‚Œãªã„ã€‚
            console.log(postData);

            addDoc(collection(db, "board"), postData); //addDoc(ãƒ©ãƒ³ãƒ€ãƒ ãªIDãŒä»˜ä¸ã•ã‚ŒãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ä½œæˆ)ã€FBã«ç™»éŒ²ã—ã¦ã„ã‚‹
            $("#storeName").val(""); //#textã®valueå€¤ã‚’å–å¾—ã™ã‚‹â†’#textã‚’ç©ºã«ã™ã‚‹
            $("#itemName").val(""); //#nameã‚’ç©ºã«ã™ã‚‹




        });




        // â†“ãƒšãƒ¼ã‚¸ãŒèª­ã¿è¾¼ã¾ã‚ŒãŸæ™‚ç‚¹ã§ç™ºå‹•ã—ã¦ã‚‹ã‚‚ã®
        // ã€æ™‚é–“é †ã«ä¸¦ã¹ã‚‹ã€‘
        // ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã®æ¡ä»¶ã‚’æŒ‡å®šã™ã‚‹ï¼ˆã“ã“ã§ã¯æ™‚é–“ã®æ–°ã—ã„é †ã«ä¸¦ã³æ›¿ãˆï¼‰
        const q = query(collection(db, "board"), orderBy("time", "desc"));//timeãƒ‘ãƒ¼ãƒˆã ã‘è¦‹ã¦æœ€æ–°é †ã«ä¸¦ã¹æ›¿ãˆã¦ã£ã¦æŒ‡ç¤ºã‚’FBã«å‡ºã—ã¦
        // ã€å…±é€šç”¨èªã€‘queryâ‡¨timeã¨ã‹nameãã‚Œãã‚Œã«å…¥åŠ›ã•ã‚ŒãŸã‚‚ã®ãŒå…¥ã£ãŸç®±
        // å¤‰æ•°qã®å¼•æ•°ãŒqueryä»¥ä¸‹ï¼†orderBy
        // orderByâ†’ä¸¦ã¹æ›¿ãˆã‚‹
        // å®šæ•°qã«ï¼ä»¥é™ã®å‡¦ç†ã‚’å…¥ã‚ŒãŸã„


        onSnapshot(q, (querySnapshot) => { //ä¸¦ã³æ›¿ãˆãŸçŠ¶æ…‹ã®ã‚‚ã®qã‚’å¤‰æ•°Aã«å…¥ã‚Œã¦ãã ã•ã„
            console.log(querySnapshot.docs);
            //onSnapshot() ã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¸Šã§ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›´ãŒç™ºç”Ÿã—ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ {} å†…ã®å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ï¼
            // ãƒ‡ãƒ¼ã‚¿å–å¾—æ¡ä»¶ãŒã“ã“ã¾ã§
            // querySnapshotã¯å‹æ‰‹ã«æ±ºã‚ãŸå¤‰æ•°å
            // 



            // â‘ ãƒ‡ãƒ¼ã‚¿å–å¾—å‡¦ç†
            // onSnapshot(collection(db, "chat"), (querySnapshot) => {
            //   console.log(querySnapshot.docs);


            // ä¸Šè¨˜ querySnapshot.docs ã¯éå¸¸ã«è¤‡é›‘ãªå½¢ã¨ãªã£ã¦ãŠã‚Šï¼Œã“ã®ã¾ã¾æ‰±ã†ã“ã¨ã¯é›£ã—ã„ï¼
            // ãã®ãŸã‚ï¼Œå¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã®ã¿æŠ½å‡ºã—ãŸã€Œã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå½¢å¼ã®é…åˆ—ã€ã«å¤‰æ›ã™ã‚‹ï¼
            // â‘¡ã€ãƒ‡ãƒ¼ã‚¿ã®å–ã‚Šå‡ºã—ã€‘
            const documents = []; //documentsé…åˆ—ã‚’ä½œã‚‹
            querySnapshot.docs.forEach(function (doc) { //forEachâ†’é…åˆ—ã«ç‰¹åŒ–ã—ãŸãƒ«ãƒ¼ãƒ—æ§‹æ–‡ å„è¦ç´ ã‚’å‡ºåŠ›ã™ã‚‹
                // querysnapshotã®ä¸­ã®docsã®ä¸­ã®å€¤ã ã‘ã‚’1ä»¶ãšã¤forEachã§å‡ºåŠ›ã™ã‚‹
                const document = {
                    id: doc.id, //.id ã§ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ IDï¼ˆåå‰ï¼‰ã‚’å–å¾—ã™ã‚‹ï¼ idâ†’key doc.idâ†’value
                    data: doc.data(), //.data() ã§ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä¸­èº«ï¼ˆ3 é …ç›®ï¼‰ã‚’å–å¾—ã™ã‚‹ï¼
                }; //ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå‹ã®å®šæ•°ã®åå‰ã‚’documentã¨ã—ã¾ã™
                documents.push(document);
            });

            console.log(documents);


            // ã€ç”»é¢è¡¨ç¤ºã™ã‚‹ãŸã‚ã®ã‚¿ã‚°ç”Ÿæˆã€‘

            const htmlElements = [] //é…åˆ—htmlElementsï¼ˆä¸­èº«ç©ºã£ã½ï¼‰ã‚’ä½œã‚Šã¾ã™
            documents.forEach(function (document) { //documentsã¯å¤‰æ•°åã€‚forEachâ†’1ä»¶1ä»¶å‡ºåŠ›ã™ã‚‹ã€‚å‡ºåŠ›ã—ãŸã‚‚ã®ã‚’æ¯å›documentã«å…¥ã‚Œã¦ã€
                htmlElements.push(`
      <p>${convertTimestampToDatetime(document.data.time.seconds)}</p>
      <p>${document.data.storeName} </p>
      <p>${document.data.itemName}</p><hr>

  `); //é…åˆ—htmlElementsã«(ä»¥ä¸‹ã‚’å…¥ã‚Œã‚‹ã‚ˆ
                // `(ãƒãƒƒã‚¯ã‚¯ã‚ªãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³)ã§å›²ã‚€ã¨ã€æ”¹è¡ŒãŒå¯èƒ½
            });

            console.log(htmlElements)

            $("#output").html(htmlElements);
            //é…åˆ—ã‚ªãƒ¼ãƒ«ã‚’#outputã«è¡¨ç¤ºã™ã‚‹
        });



    </script>

    <script>
        // æ—¥æ™‚ã‚’ã„ã„æ„Ÿã˜ã®å½¢å¼ã«ã™ã‚‹é–¢æ•°
        function convertTimestampToDatetime(timestamp) {
            const _d = timestamp ? new Date(timestamp * 1000) : new Date();
            const Y = _d.getFullYear();
            const m = (_d.getMonth() + 1).toString().padStart(2, '0');
            const d = _d.getDate().toString().padStart(2, '0');
            const H = _d.getHours().toString().padStart(2, '0');
            const i = _d.getMinutes().toString().padStart(2, '0');
            const s = _d.getSeconds().toString().padStart(2, '0');
            return `${Y}/${m}/${d} ${H}:${i}:${s}`;
        }
    </script>
</body>

</html>